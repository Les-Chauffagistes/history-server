name: Build & Publish Docker Image

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: [self-hosted, Linux, X64]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build & push image
      id: build
      run: |
        IMAGE=ghcr.io/les-chauffagistes/history-server
        TAG=${GITHUB_SHA}

        docker build -t $IMAGE:$TAG .
        docker push $IMAGE:$TAG

        DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' $IMAGE:$TAG | cut -d@ -f2)
        echo "digest=$DIGEST" >> $GITHUB_OUTPUT
    
    - name: Get current deployed digest
      id: current
      run: |
        curl -s \
          -H "Authorization: token ${{ secrets.DEPLOY_REPO_TOKEN }}" \
          https://raw.githubusercontent.com/Les-Chauffagistes/heatboard-deploy/develop/services/history-server.digest \
          > current.digest || echo "" > current.digest

        echo "digest=$(cat current.digest)" >> $GITHUB_OUTPUT
    
    - name: Check digest change
      id: compare
      run: |
        if [ "${{ steps.build.outputs.digest }}" = "${{ steps.current.outputs.digest }}" ]; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi

    - name: tag latest
      if: github.ref == 'refs/heads/main'
      run: |
        docker tag ghcr.io/les-chauffagistes/history-server:${{ github.sha }} ghcr.io/les-chauffagistes/history-server:latest
        docker push ghcr.io/les-chauffagistes/history-server:latest
    
    - name: Notify orchestration repo
      if: steps.compare.outputs.changed == 'true'
      run: |
        curl -X POST \
          -H "Authorization: token ${{ secrets.DEPLOY_REPO_TOKEN }}" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/Les-Chauffagistes/heatboard-deploy/dispatches \
          -d '{
            "event_type": "image_built",
            "client_payload": {
              "service": "history-server",
              "image": "ghcr.io/les-chauffagistes/history-server",
              "tag": "'${GITHUB_SHA}'",
              "digest": "${{ steps.build.outputs.digest }}"
            }
          }'